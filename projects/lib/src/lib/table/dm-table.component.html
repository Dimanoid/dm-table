@if (noColumns && !showSelectColumn) {
    <div class="ngx-dmt-nocolumns"><span></span></div>
}
@else if (ctMap) {
    <div class="ngx-dmt-header-wrapper" [style.margin-right.px]="scrollBarWidth" #headerWrapper>
        <table class="ngx-dmt ngx-dmt-header" [ngClass]="tableClass!">
            <colgroup>
                @if (showSelectColumn) {
                    <col [style.width]="noColumns ? '100%' : selectColumnWidth + 'px'">
                }
                @for (cid of colsOrder; track cid) {
                    <col [style.width]="colsOrder!.length == 1 ? '100%' : (resizeColumnId ? colsWidthTmp[cid] : colsWidth[cid]) + 'px'">
                }
            </colgroup>
            <thead>
                <tr class="ngx-dmt-header-row"
                    cdkDropList cdkDropListOrientation="horizontal"
                    (cdkDropListDropped)="columnHeaderDrop($event)">
                    @if (showSelectColumn && selectColumnHeaderTpl) {
                        <th class="ngx-dmt-header-cell ngx-dmt-header-cell-select" (click)="toggleSelectAll($event)">
                            <ng-container [ngTemplateOutlet]="selectColumnHeaderTpl" [ngTemplateOutletContext]="{ all: allRowsSelected, none: allRowsNotSelected }" />
                        </th>
                    }
                    @for (cid of colsOrder; track cid; let ci = $index, f = $first, l = $last) {
                        <th class="ngx-dmt-header-cell"
                            [title]="ctMap[cid].headerTooltip ? ctMap[cid].headerTooltip : ''"
                            [ngClass]="ctMap[cid].headerClass!"
                            [class.ngx-dmt-sortable]="ctMap[cid].sortable"
                            [class.ngx-dmt-resizable]="ctMap[cid].resizable && !l"
                            [class.ngx-dmt-sorted]="(sort && (sort.colId == cid || sort.colId == ctMap[cid].colIdAlias)) || (!sort && multiSort && multiSort[cid] != null)"
                            [class.ngx-dmt-sorted-asc]="(sort && sort.order > 0) || (!sort && multiSort && multiSort[cid] > 0)"
                            [class.ngx-dmt-sorted-desc]="(sort && sort.order < 0) || (!sort && multiSort && multiSort[cid] < 0)"
                            (click)="headerClick.emit({ colId: cid, index: ci, first: f, last: l, event: $event })"
                            (contextmenu)="headerContextMenu.emit({ colId: cid, index: ci, first: f, last: l, event: $event })"
                            cdkDrag cdkDragLockAxis="x" [cdkDragDisabled]="!moveableColumns">
                            <div class="ngx-dmt-column-title" (click)="ctMap[cid].sortable ? toggleSort(cid) : null">
                                @if (ctMap[cid].headerTpl) {
                                    <ng-container [ngTemplateOutlet]="ctMap[cid].headerTpl!" />
                                }
                                @else {
                                    {{ ctMap[cid].title }}
                                }
                            </div>
                            @if (moveableColumns) {
                                <div class="ngx-dmt-column-draghandle" cdkDragHandle><i class="ngx-dmt-column-draghandle-icon ngx-dmt-icon-font"></i></div>
                            }
                            @if (ctMap[cid].sortable) {
                                <div class="ngx-dmt-column-sort-container" (click)="toggleSort(cid)">
                                    <i class="ngx-dmt-column-sort-toggle ngx-dmt-icon-font"></i>
                                    @if (multiSort && multiSort[cid] != null) {
                                        <span class="ngx-dmt-column-sort-count">{{ abs(multiSort[cid]) }}</span>
                                    }
                                </div>
                            }
                            @if (ctMap[cid].resizable) {
                                <div class="ngx-dmt-resizer"
                                    [class.ngx-dmt-resizer-dragging]="resizeColumnId == cid"
                                    (mousedown)="resizeColumnStart(cid, resizer, $event)"
                                    #resizer>
                                </div>
                            }
                        </th>
                    }
                </tr>
            </thead>
        </table>
    </div>
    <div class="ngx-dmt-body-wrapper">
        @if (resizerDiv && resizeColumnId) {
            <div class="ngx-dmt-resizer" [style.left.px]="resizerX"></div>
        }
        <cdk-virtual-scroll-viewport [itemSize]="itemSize" class="ngx-dmt-body-wrapper-inner" (scroll)="scroll($event)">
            <table class="ngx-dmt ngx-dmt-body" [ngClass]="tableClass!">
                <colgroup>
                    @if (showSelectColumn) {
                        <col [style.width]="noColumns ? '100%' : selectColumnWidth + 'px'">
                    }
                    @for (cid of colsOrder; track cid) {
                        <col [style.width]="colsOrder!.length == 1 ? '100%' : colsWidth[cid] + 'px'">
                    }
                </colgroup>
                @if (rows) {
                    <tbody>
                        <ng-container *cdkVirtualFor="let r of $any(rows); let ri = index; trackBy: trackByFn">
                            @if (groupped && groupHeaderTpl && groupStart && groupStart[ri]) {
                                <tr class="ngx-dmt-group-header-row">
                                    <td [colSpan]="colsOrder!.length + (showSelectColumn ? 1 : 0)"
                                        class="ngx-dmt-group-header-cell"
                                        [class.ngx-dmt-group-header-cell-collapsible]="groupStart[ri].collapsible"
                                        [class.ngx-dmt-group-header-cell-collapsed]="groupStart[ri].collapsed">
                                        <ng-container [ngTemplateOutlet]="groupHeaderTpl" [ngTemplateOutletContext]="{ row: r, ri: ri, group: groupStart[ri] }" />
                                    </td>
                                </tr>
                            }
                            <!-- @if (!groupped || (groupStart && groupStart[ri] && groupStart[ri].collapsible && !groupStart[ri].collapsed)) { -->
                                <tr class="ngx-dmt-row"
                                    [ngClass]="getRowClasses(r, ri)"
                                    [draggable]="rowsDragEnabled"
                                    (dragstart)="onRowDragStart(ri, r, $event)"
                                    (dragend)="onRowDragEnd(ri, r, $event)"
                                    (dragleave)="onRowDragLeave(ri, r, $event, bodyRow)"
                                    (dragenter)="onRowDragEnter(ri, r, $event, bodyRow)"
                                    (dragover)="onRowDragOver(ri, r, $event, bodyRow)"
                                    (drop)="onRowDrop(ri, r, $event, bodyRow)"
                                    (click)="rowClick.emit({ index: ri, row: r, event: $event })"
                                    (contextmenu)="rowContextMenu.emit({ index: ri, row: r, event: $event })"
                                    #bodyRow>
                                    @if (showSelectColumn) {
                                        <td class="ngx-dmt-cell ngx-dmt-cell-select" (click)="noColumns ? undefined : toggleSelect(r, $event)">
                                            <ng-container
                                                [ngTemplateOutlet]="selectColumnTpl!"
                                                [ngTemplateOutletContext]="{ row: r, $implicit: isRowSelected(r), ri: ri }">
                                            </ng-container>
                                        </td>
                                    }
                                    @for (cid of colsOrder; track cid; let i = $index) {
                                        <td class="ngx-dmt-cell"
                                            [ngClass]="getCellClasses(r, cid, ri, i)!"
                                            [style.white-space]="ctMap[cid].whitespace">
                                            @if (ctMap[cid].cellTpl) {
                                                <ng-container [ngTemplateOutlet]="ctMap[cid].cellTpl!" [ngTemplateOutletContext]="{ row: r, ct: ctMap[cid], $implicit: r[cid], ci: i, ri: ri }" />
                                            }
                                            @else {
                                                {{ r[cid] }}
                                            }
                                        </td>
                                    }
                                </tr>
                                @if (groupped && groupFooterTpl && groupEnd![ri]) {
                                    <tr class="ngx-dmt-group-footer-row">
                                        <td [colSpan]="colsOrder!.length + (showSelectColumn ? 1 : 0)" class="ngx-dmt-group-footer-cell">
                                            <ng-container [ngTemplateOutlet]="groupFooterTpl"
                                                [ngTemplateOutletContext]="{ row: r, ri: ri, group: groupEnd![ri] }">
                                            </ng-container>
                                        </td>
                                    </tr>
                                }
                            <!-- } -->
                        </ng-container>
                    </tbody>
                }
            </table>
        </cdk-virtual-scroll-viewport>
        @if (noItems && noItemsTpl) {
            <ng-container [ngTemplateOutlet]="noItemsTpl" />
        }
        @if (noItemsVisible && noItemsVisibleTpl) {
            <ng-container [ngTemplateOutlet]="noItemsVisibleTpl" />
        }
    </div>
    @if (hasFooter) {
        <div class="ngx-dmt-footer-wrapper" [style.margin-right.px]="scrollBarWidth">
            <table class="ngx-dmt ngx-dmt-footer" [ngClass]="tableClass!">
                <colgroup>
                    @if (showSelectColumn) {
                        <col [style.width]="noColumns ? '100%' : selectColumnWidth + 'px'">
                    }
                    @for (cid of colsOrder; track cid) {
                        <col [style.width]="colsOrder!.length == 1 ? '100%' : colsWidth[cid] + 'px'">
                    }
                </colgroup>
                <tfoot>
                    <tr>
                        @for (cid of colsOrder; track cid) {
                            <td [ngClass]="ctMap[cid].footerClass!">
                                @if (ctMap[cid].footerTpl) {
                                    <ng-container [ngTemplateOutlet]="ctMap[cid].footerTpl!" />
                                }
                                @else {
                                    &nbsp;
                                }
                            </td>
                        }
                    </tr>
                </tfoot>
            </table>
        </div>
    }
}
